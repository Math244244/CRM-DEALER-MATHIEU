<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>CRM s√©curis√©</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CSS pour styles rapides -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Flatpickr CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
  />
  <!-- XLSX pour l‚Äôimport/export Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <!-- Font Awesome pour quelques ic√¥nes -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />

  <link
    rel="stylesheet"
    href="Style.css"
  />
  <!-- docx.js pour exporter les notes en .docx -->
  <script src="https://cdn.jsdelivr.net/npm/docx@7.2.1/build/index.umd.min.js"></script>

  
</head>

<body class="min-h-screen flex flex-col items-center relative overflow-x-hidden">
  <!-- Overlay pour login -->
  <div id="login-overlay">
    <div id="login-box">
      <h2>Se connecter au CRM</h2>
      <input type="password" id="login-password" placeholder="Mot de passe" />
      <label>
        <input type="checkbox" id="login-remember" /> Se souvenir de moi
      </label>
      <button id="login-submit">Valider</button>
    </div>
  </div>

  <!-- Fond d‚Äô√©cran + calque rouge -->
  <div class="bg-car-visible"></div>
  <div class="bg-red-overlay"></div>

  <!-- Bouton D√©connexion -->
  <button id="logout-btn">D√©connexion</button>

  <!-- En-t√™te / Logo -->
  <header class="w-full flex flex-col items-center py-7" style="z-index: 21;">
    <span class="crm-logo-text tracking-widest select-none">CRM</span>
  </header>

  <!-- Barre de Navigation -->
  <nav
    class="w-full max-w-[98vw] flex flex-wrap justify-center mb-2 relative z-20"
  >
    <div class="flex flex-wrap justify-center">
      <button class="nav-tab" id="tab-accueil-btn">Accueil</button>
      <button class="nav-tab" id="tab-performance-btn">
        Suivi performance mensuelle
      </button>
      <button class="nav-tab" id="tab-visite-btn">
        Visite concessionnaire
      </button>
      <button class="nav-tab" id="tab-calc-btn">Calculatrice financi√®re</button>
      <button class="nav-tab" id="tab-garantie-btn">Outil Visuel Garantie</button>
      <button class="nav-tab" id="tab-livraison-btn">Feuille de livraison</button>
    </div>
  </nav>

  <main class="w-full flex-1 flex flex-col gap-4 px-1 md:px-8 mb-10 relative z-10">
    <!-- ==================== Onglet Accueil ==================== -->
    <section id="tab-accueil" class="crm-card mt-2 shadow-2xl">
      <div class="flex flex-col items-center py-8">
        <h2 class="text-4xl font-bold text-red-700 mb-3 tracking-wider">
          Bienvenue dans votre CRM
        </h2>
        <p
          class="text-lg text-gray-700 text-center max-w-2xl mb-6"
        >
          G√©rez, analysez et suivez vos concessionnaires : performances
          mensuelles, visites, historiques, notes‚Ä¶<br />
          <span class="font-semibold text-red-600"
            >Tout est synchronis√© et √† jour !</span
          >
        </p>
        <!-- Phrase agrandie ici -->
        <div class="mt-8">
          <span
            class="text-2xl italic text-gray-600 border-l-4 border-red-400 pl-4"
          >
            ‚ÄúOn sauvesdsdsdsds pas des vies, on vend des Garanties.‚Äù</span
          >
        </div>
        <div class="text-gray-500 text-sm mt-6">
          &copy; <span id="footer-year">2025</span> ‚Äì Avantage Plus
        </div>
      </div>
    </section>

    <!-- =========================================== Onglet Suivi performance mensuelle =========================================== -->
    <section
      id="tab-performance"
      class="crm-card p-4 mt-2 shadow-2xl hidden"
    >
      <div
        class="flex flex-col md:flex-row md:items-center md:justify-between mb-4 gap-2"
      >
        <input
          id="search-performance"
          type="text"
          placeholder="Rechercher un concessionnaire‚Ä¶"
          class="max-w-sm px-4 py-2 rounded-xl border border-gray-300 shadow focus:outline-none focus:border-red-600 text-lg"
        />
        <div class="flex gap-2">
          <button
            class="bg-green-600 text-white px-4 py-2 rounded-xl shadow hover:bg-green-700 font-semibold"
            id="btn-add-row"
          >
            + Ajouter
          </button>
          <button
            class="bg-indigo-600 text-white px-4 py-2 rounded-xl shadow hover:bg-indigo-700 font-semibold"
            id="btn-new-year"
          >
            Nouvelle ann√©e
          </button>
          <button
            class="bg-blue-600 text-white px-4 py-2 rounded-xl shadow hover:bg-blue-700 font-semibold"
            id="btn-import"
          >
            Importer Excel/CSV
          </button>
          <button
            class="bg-blue-600 text-white px-4 py-2 rounded-xl shadow hover:bg-blue-700 font-semibold"
            id="btn-export-excel"
          >
            Exporter Excel/CSV
          </button>
        </div>
      </div>
      <input
        type="file"
        id="file-input"
        accept=".xlsx,.xls,.csv"
        class="hidden"
      />
      <div id="performance-table-container" class="crm-table-scroll"></div>
    </section>

    <!-- ========================= Onglet Visite concessionnaire ========================= -->
    <section id="tab-visite" class="crm-card p-4 mt-2 hidden shadow-2xl">
      <div
        class="flex flex-col md:flex-row md:items-center md:justify-between mb-4 gap-2"
      >
        <input
          id="search-visite"
          type="text"
          placeholder="Rechercher un concessionnaire‚Ä¶"
          class="max-w-sm px-4 py-2 rounded-xl border border-gray-300 shadow focus:outline-none focus:border-red-600 text-lg"
        />
      </div>
      <div id="visite-table-container" class="crm-table-scroll"></div>
    </section>

    <!-- =========================================== Onglet Calculatrice financi√®re =========================================== -->
    <section id="tab-calc" class="crm-card p-4 mt-2 hidden shadow-2xl">
      <div class="calc-header">Calculatrices financi√®res</div>
      <div class="calc-subheader">Outil professionnel pour concessionnaires automobiles</div>

      <div class="section-title-blue">Comptant VS financement</div>
      <div class="container mt-2">
        <!-- Int√©r√™t compos√© -->
        <div class="calculator">
          <div class="calc-title">Int√©r√™t compos√©</div>
          <div class="calc-subtitle">Revenu de placement</div>
          <div class="input-group">
            <label for="comp-montant" class="calc-label">Montant initial ($)</label>
            <input
              type="number"
              id="comp-montant"
              value="30000"
              min="0"
              step="0.01"
              tabindex="1"
            />
          </div>
          <div class="input-group">
            <label for="comp-taux" class="calc-label"
              >Taux d‚Äôint√©r√™t annuel (%)</label
            >
            <input
              type="number"
              id="comp-taux"
              value="8"
              min="0"
              step="0.01"
              tabindex="2"
            />
          </div>
          <div class="input-group">
            <label for="comp-annees" class="calc-label">Terme (ann√©es)</label>
            <input
              type="number"
              id="comp-annees"
              value="7"
              min="1"
              step="1"
              tabindex="3"
            />
          </div>
          <div class="total-result" id="comp-total">0 $</div>
          <div class="explanation">
            Calcule le gain total d‚Äôint√©r√™ts compos√©s annuellement.
          </div>
        </div>
        <!-- Co√ªt d‚Äôemprunt -->
        <div class="calculator">
          <div class="calc-title">Co√ªt d‚Äôemprunt</div>
          <div class="calc-subtitle">Int√©r√™t pay√©</div>
          <div class="input-group">
            <label for="emp-montant" class="calc-label"
              >Montant emprunt√© ($)</label
            >
            <input
              type="number"
              id="emp-montant"
              value="30000"
              min="0"
              step="0.01"
              tabindex="4"
            />
          </div>
          <div class="input-group">
            <label for="emp-taux" class="calc-label"
              >Taux d‚Äôint√©r√™t annuel (%)</label
            >
            <input
              type="number"
              id="emp-taux"
              value="8"
              min="0"
              step="0.01"
              tabindex="5"
            />
          </div>
          <div class="input-group">
            <label for="emp-annees" class="calc-label">Dur√©e (ann√©es)</label>
            <input
              type="number"
              id="emp-annees"
              value="7"
              min="1"
              step="1"
              tabindex="6"
            />
          </div>
          <div class="total-result" id="emp-total">0 $</div>
          <div class="explanation">
            Calcule le co√ªt total des int√©r√™ts pay√©s sur l‚Äôemprunt (amortissement
            classique).
          </div>
        </div>
      </div>

      <div class="diff-box" id="diff-box">
        Diff√©rence entre les deux options : 0 $
      </div>

      <div class="section-title-blue">Marge de cr√©dit VS Pr√™t conventionnel</div>
      <div class="container-compare mt-2">
        <!-- Marge de cr√©dit -->
        <div class="calculator">
          <div class="calc-title">Calcul int√©r√™t sur Marge de cr√©dit</div>
          <div class="input-group">
            <label for="marge-montant" class="calc-label">Montant ($)</label>
            <input
              type="number"
              id="marge-montant"
              value="30000"
              min="0"
              step="0.01"
              tabindex="7"
            />
          </div>
          <div class="input-group">
            <label for="marge-taux" class="calc-label">Taux annuel (%)</label>
            <input
              type="number"
              id="marge-taux"
              value="5"
              min="0"
              step="0.01"
              tabindex="8"
            />
          </div>
          <div class="input-group">
            <label for="marge-annees" class="calc-label">Terme (ann√©es)</label>
            <input
              type="number"
              id="marge-annees"
              value="7"
              min="0"
              step="1"
              tabindex="9"
            />
          </div>
          <div class="total-result" id="marge-total">0 $</div>
          <div class="explanation">
            Int√©r√™t total √† payer sur la marge de cr√©dit (amortissement mensuel fixe).
          </div>
        </div>
        <!-- Pr√™t automobile -->
        <div class="calculator">
          <div class="calc-title">Calcul int√©r√™t sur Pr√™t automobile</div>
          <div class="input-group">
            <label for="pret-montant" class="calc-label">Montant ($)</label>
            <input
              type="number"
              id="pret-montant"
              value="30000"
              min="0"
              step="0.01"
              tabindex="10"
            />
          </div>
          <div class="input-group">
            <label for="pret-taux" class="calc-label">Taux annuel (%)</label>
            <input
              type="number"
              id="pret-taux"
              value="8"
              min="0"
              step="0.01"
              tabindex="11"
            />
          </div>
          <div class="input-group">
            <label for="pret-annees" class="calc-label">Terme (ann√©es)</label>
            <input
              type="number"
              id="pret-annees"
              value="7"
              min="1"
              step="1"
              tabindex="12"
            />
          </div>
          <div class="total-result" id="pret-total">0 $</div>
          <div class="explanation">
            Int√©r√™t total √† payer sur le pr√™t automobile (amortissement mensuel fixe).
          </div>
        </div>
      </div>

      <div class="compare-diff-per-two-weeks" id="compare-diff-per-two-weeks">
        Diff√©rence aux deux semaines : 0 $
      </div>

      <div class="disclaimer text-center mt-6 px-4">
        <p class="text-gray-800 text-sm italic">
          Les r√©sultats affich√©s sont des estimations √† titre indicatif seulement.
          Malgr√© le soin apport√©, des √©carts ou erreurs peuvent subsister selon les
          situations r√©elles. Validez toujours avec votre conseiller financier.
        </p>
      </div>
    </section>

    <!-- =========================================== Onglet Outil Visuel Garantie =========================================== -->
    <section
      id="tab-garantie"
      class="hidden p-0 shadow-2xl"
      style="background: transparent; box-shadow: none;"
    >
      <div class="main-content">
        <div class="main-title">Garantie Manufacturi√®re VS Ann√©es Projet√©</div>
        <div class="container-main">
          <!-- Formulaire √† gauche -->
          <form class="form-side" onsubmit="return false">
            <div class="form-group">
              <label for="date-mise-en-service">Date de mise en service</label>
              <input type="date" id="date-mise-en-service" value="2023-01-01" required />
            </div>
            <div class="onglet-section">
              <div class="onglet-title">√âtat actuel</div>
              <div class="flex flex-col md:flex-row md:items-center gap-4">
                <div class="flex flex-col">
                  <label for="date-aujourd‚Äôhui">Date d‚Äôaujourd‚Äôhui</label>
                  <input type="date" id="date-aujourd‚Äôhui" required />
                </div>
                <div class="flex flex-col">
                  <label for="km-aujourd‚Äôhui">Kilom√©trage aujourd‚Äôhui</label>
                  <input
                    type="number"
                    id="km-aujourd‚Äôhui"
                    min="0"
                    max="260000"
                    step="1000"
                    value="0"
                    required
                  />
                </div>
              </div>
            </div>
            <div class="form-group">
              <label for="annees-projetees">Combien d‚Äôann√©es vous comptez garder la voiture</label>
              <input
                type="number"
                id="annees-projetees"
                min="0"
                max="15"
                value="0"
                required
              />
            </div>
            <div class="form-group">
              <label for="km-par-an">Km par ann√©e</label>
              <input
                type="number"
                id="km-par-an"
                min="0"
                max="70000"
                step="100"
                value="0"
                required
              />
            </div>
            <div class="form-group">
              <label>Total km projet√©s</label>
              <input
                type="number"
                id="km-projet√©"
                readonly
                style="background: #EAF8EA; color: #076A15; font-weight: bold;"
              />
            </div>
          </form>
          <!-- Graphique √† droite -->
          <div class="graph-section">
            <div class="graph-title">
              <svg fill="none" viewBox="0 0 32 32">
                <rect x="4" y="15" width="24" height="5" rx="2.5" fill="#B4001A" />
                <rect x="7" y="10" width="18" height="7" rx="2" fill="#555" />
                <rect x="10" y="7" width="12" height="5" rx="2" fill="#C8102E" />
              </svg>
              Projection de couverture
            </div>
            <div class="badge-constructeur">
              <svg viewBox="0 0 22 22" fill="none">
                <circle cx="11" cy="11" r="10" stroke="#fff" stroke-width="2" />
                <path
                  d="M6 13l3-4 3 4 3-6"
                  stroke="#fff"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
              Garantie constructeur
            </div>
            <div class="graph-area" style="position: relative;">
              <canvas id="canvas-graph" width="900" height="540"></canvas>
              <div id="years-labels" class="years-labels"></div>
            </div>
            <div class="legend">
              <span
                ><span class="legend-box legend-base"></span> Garantie de base (3 ans /
                60 000 km)</span
              >
              <span
                ><span class="legend-box legend-hachure"></span> Garantie d√©j√†
                consomm√©e</span
              >
              <span
                ><span class="legend-box legend-proj-hach"></span> Couverture
                projet√©e (sous garantie)</span
              >
              <span
                ><span class="legend-box legend-proj"></span> Couverture
                projet√©e (hors garantie)</span
              >
              <span
                ><span class="legend-current"></span> Position actuelle</span
              >
            </div>
            <button class="btn-export" id="btn-export-garantie">
              Exporter le graphique en PNG
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- =========================================== Onglet Feuille de livraison =========================================== -->
    <section id="tab-livraison" class="crm-card mt-2 shadow-2xl hidden">
      <div class="content-livraison">
        <div class="title-box">Offre de services et pr√©paration v√©hicule</div>
        <form>
          <!-- Extension de garantie -->
          <div class="glass-card">
            <div class="cat-title-wrap">
              <div class="cat-title">
                <i class="fa-solid fa-car-side"></i> Extension de garantie
              </div>
            </div>
            <table class="livraison-table">
              <tr>
                <th class="livraison-th">Produit / Option</th>
                <th class="livraison-th check-col">Oui</th>
                <th class="livraison-th check-col">Non</th>
                <th class="livraison-th note-col">Notes</th>
              </tr>
              <tr>
                <td class="livraison-td">
                  Extension de garantie couverture compl√®te
                </td>
                <td class="livraison-td check-col">
                  <input type="checkbox" class="checkbox" name="garantie_oui" />
                </td>
                <td class="livraison-td check-col">
                  <input type="checkbox" class="checkbox" name="garantie_non" />
                </td>
                <td class="livraison-td note-col">
                  <textarea class="note-field"></textarea>
                </td>
              </tr>
            </table>
          </div>
          <!-- Pr√©paration esth√©tique -->
          <div class="glass-card mt-6">
            <div class="cat-title-wrap">
              <div class="cat-title">
                <i class="fa-solid fa-soap"></i> Pr√©paration esth√©tique du v√©hicule
              </div>
            </div>
            <table class="livraison-table">
              <tr>
                <th class="livraison-th">Produit / Option</th>
                <th class="livraison-th check-col">Oui</th>
                <th class="livraison-th check-col">Non</th>
                <th class="livraison-th note-col">Notes</th>
              </tr>
              <tr>
                <td class="livraison-td">Antirouille</td>
                <td class="livraison-td check-col">
                  <input type="checkbox" class="checkbox" name="antirouille_oui" />
                </td>
                <td class="livraison-td check-col">
                  <input type="checkbox" class="checkbox" name="antirouille_non" />
                </td>
                <td class="livraison-td note-col">
                  <textarea class="note-field"></textarea>
                </td>
              </tr>
              <tr>
                <td class="livraison-td">Pierre de capot</td>
                <td class="livraison-td check-col">
                  <input type="checkbox" class="checkbox" name="capot_oui" />
                </td>
                <td class="livraison-td check-col">
                  <input type="checkbox" class="checkbox" name="capot_non" />
                </td>
                <td class="livraison-td note-col">
                  <textarea class="note-field"></textarea>
                </td>
              </tr>
              <tr>
                <td class="livraison-td">Scellant √† peinture</td>
                <td class="livraison-td check-col">
                  <input type="checkbox" class="checkbox" name="scellant_oui" />
                </td>
                <td class="livraison-td check-col">
                  <input type="checkbox" class="checkbox" name="scellant_non" />
                </td>
                <td class="livraison-td note-col">
                  <textarea class="note-field"></textarea>
                </td>
              </tr>
              <tr>
                <td class="livraison-td">Syst√®me antivol</td>
                <td class="livraison-td check-col">
                  <input type="checkbox" class="checkbox" name="antivol_oui" />
                </td>
                <td class="livraison-td check-col">
                  <input type="checkbox" class="checkbox" name="antivol_non" />
                </td>
                <td class="livraison-td note-col">
                  <textarea class="note-field"></textarea>
                </td>
              </tr>
            </table>
          </div>
          <!-- Assurance cr√©dit -->
          <div class="glass-card mt-6">
            <div class="cat-title-wrap">
              <div class="cat-title">
                <i class="fa-solid fa-shield-halved"></i> Assurance cr√©dit
              </div>
            </div>
            <table class="livraison-table">
              <tr>
                <th class="livraison-th">Produit / Option</th>
                <th class="livraison-th check-col">Oui</th>
                <th class="livraison-th check-col">Non</th>
                <th class="livraison-th note-col">Notes</th>
              </tr>
              <tr>
                <td class="livraison-td">Assurance-vie</td>
                <td class="livraison-td check-col">
                  <input type="checkbox" class="checkbox" name="vie_oui" />
                </td>
                <td class="livraison-td check-col">
                  <input type="checkbox" class="checkbox" name="vie_non" />
                </td>
                <td class="livraison-td note-col">
                  <textarea class="note-field"></textarea>
                </td>
              </tr>
              <tr>
                <td class="livraison-td">Assurance invalidit√©</td>
                <td class="livraison-td check-col">
                  <input type="checkbox" class="checkbox" name="invalidite_oui" />
                </td>
                <td class="livraison-td check-col">
                  <input type="checkbox" class="checkbox" name="invalidite_non" />
                </td>
                <td class="livraison-td note-col">
                  <textarea class="note-field"></textarea>
                </td>
              </tr>
              <tr>
                <td class="livraison-td">Assurance maladie grave</td>
                <td class="livraison-td check-col">
                  <input type="checkbox" class="checkbox" name="maladie_oui" />
                </td>
                <td class="livraison-td check-col">
                  <input type="checkbox" class="checkbox" name="maladie_non" />
                </td>
                <td class="livraison-td note-col">
                  <textarea class="note-field"></textarea>
                </td>
              </tr>
            </table>
          </div>
          <!-- Assurance de remplacement -->
          <div class="glass-card mt-6">
            <div class="cat-title-wrap">
              <div class="cat-title">
                <i class="fa-solid fa-hand-holding-heart"></i> Assurance de
                remplacement
              </div>
            </div>
            <table class="livraison-table">
              <tr>
                <th class="livraison-th">Produit / Option</th>
                <th class="livraison-th check-col">Oui</th>
                <th class="livraison-th check-col">Non</th>
                <th class="livraison-th note-col">Notes</th>
              </tr>
              <tr>
                <td class="livraison-td">Assurance de remplacement</td>
                <td class="livraison-td check-col">
                  <input
                    type="checkbox"
                    class="checkbox"
                    name="remplacement_oui"
                  />
                </td>
                <td class="livraison-td check-col">
                  <input
                    type="checkbox"
                    class="checkbox"
                    name="remplacement_non"
                  />
                </td>
                <td class="livraison-td note-col">
                  <textarea class="note-field"></textarea>
                </td>
              </tr>
            </table>
          </div>
          <!-- Bouton Imprimer -->
          <button
            type="button"
            class="print-btn mt-6"
            onclick="window.print()"
          >
            <i class="fa-solid fa-print"></i> Imprimer / T√©l√©charger
          </button>
        </form>
      </div>
    </section>
  </main>

  <!-- ================= Popup ‚ÄúNotes‚Äù ================= -->
  <div id="notes-overlay" class="notes-overlay" onclick="closeNotes()">
    <div class="notes-container" onclick="event.stopPropagation()">
      <div class="notes-header">
        <h3 id="notes-title">Notes</h3>
        <button onclick="closeNotes()">‚úï</button>
      </div>
      <div id="notes-list" class="notes-list"></div>
      <div class="notes-add">
        <textarea id="notes-input" placeholder="√âcrire une note‚Ä¶"></textarea>
        <button id="btn-add-note">Ajouter</button>
      </div>
      <button
        id="btn-export-notes"
        class="bg-blue-600 text-white px-4 py-2 rounded-xl shadow hover:bg-blue-700 font-semibold self-end text-sm mt-2"
      >
        Exporter les notes (Word)
      </button>
    </div>
  </div>

  <!-- ================= Popup ‚ÄúInfos Concessionnaire‚Äù ================= -->
  <div id="info-overlay" class="notes-overlay" onclick="closeNotes()">
    <div class="notes-container" onclick="event.stopPropagation()">
      <div class="notes-header">
        <h3 id="info-title">Infos Concessionnaire</h3>
        <button onclick="closeNotes()">‚úï</button>
      </div>
      <div class="notes-list" style="flex-direction: column; gap: 0.6rem">
        <!-- Propri√©taire : Nom + E-mail -->
        <div class="flex flex-col gap-2">
          <label class="font-semibold">Propri√©taire :</label>
          <input
            type="text"
            id="info-owner"
            class="border border-gray-300 rounded p-1 text-sm w-full"
            placeholder="Nom du propri√©taire"
          />
          <input
            type="email"
            id="info-owner-email"
            class="border border-gray-300 rounded p-1 text-sm w-full"
            placeholder="Adresse e-mail du propri√©taire"
            onclick="navigateToGmail('info-owner-email')"
            title="Cliquez pour envoyer un e-mail"
          />
        </div>
        <!-- Comptabilit√© : Nom + E-mail -->
        <div class="flex flex-col gap-2">
          <label class="font-semibold">Comptabilit√© :</label>
          <input
            type="text"
            id="info-accounts"
            class="border border-gray-300 rounded p-1 text-sm w-full"
            placeholder="Nom du comptable"
          />
          <input
            type="email"
            id="info-accounts-email"
            class="border border-gray-300 rounded p-1 text-sm w-full"
            placeholder="Adresse e-mail du comptable"
            onclick="navigateToGmail('info-accounts-email')"
            title="Cliquez pour envoyer un e-mail"
          />
        </div>
        <!-- FNI -->
        <div class="flex flex-col gap-2">
          <label for="info-fni" class="font-semibold">FNI :</label>
          <input
            type="text"
            id="info-fni"
            class="border border-gray-300 rounded p-1 text-sm w-full"
            placeholder="Num√©ro FNI"
          />
        </div>
        <!-- Dir. Service : Nom + E-mail -->
        <div class="flex flex-col gap-2">
          <label class="font-semibold">Dir. Service :</label>
          <input
            type="text"
            id="info-dir"
            class="border border-gray-300 rounded p-1 text-sm w-full"
            placeholder="Nom du directeur service"
          />
          <input
            type="email"
            id="info-dir-email"
            class="border border-gray-300 rounded p-1 text-sm w-full"
            placeholder="Adresse e-mail du directeur service"
            onclick="navigateToGmail('info-dir-email')"
            title="Cliquez pour envoyer un e-mail"
          />
        </div>
        <!-- Directeurs financiers (jusqu'√† 3) -->
        <div class="flex flex-col gap-2">
          <label class="font-semibold">Directeur financier #1 :</label>
          <input
            type="text"
            id="info-df1"
            class="border border-gray-300 rounded p-1 text-sm w-full"
            placeholder="Nom du DF#1"
          />
          <input
            type="email"
            id="info-df1-email"
            class="border border-gray-300 rounded p-1 text-sm w-full"
            placeholder="Email DF#1"
            onclick="navigateToGmail('info-df1-email')"
            title="Cliquez pour envoyer un e-mail"
          />
        </div>
        <div class="flex flex-col gap-2">
          <label class="font-semibold">Directeur financier #2 :</label>
          <input
            type="text"
            id="info-df2"
            class="border border-gray-300 rounded p-1 text-sm w-full"
            placeholder="Nom du DF#2"
          />
          <input
            type="email"
            id="info-df2-email"
            class="border border-gray-300 rounded p-1 text-sm w-full"
            placeholder="Email DF#2"
            onclick="navigateToGmail('info-df2-email')"
            title="Cliquez pour envoyer un e-mail"
          />
        </div>
        <div class="flex flex-col gap-2">
          <label class="font-semibold">Directeur financier #3 :</label>
          <input
            type="text"
            id="info-df3"
            class="border border-gray-300 rounded p-1 text-sm w-full"
            placeholder="Nom du DF#3"
          />
          <input
            type="email"
            id="info-df3-email"
            class="border border-gray-300 rounded p-1 text-sm w-full"
            placeholder="Email DF#3"
            onclick="navigateToGmail('info-df3-email')"
            title="Cliquez pour envoyer un e-mail"
          />
        </div>
      </div>
      <button
        id="btn-save-info"
        class="bg-green-600 text-white px-4 py-2 rounded-xl shadow hover:bg-green-700 font-semibold self-end text-sm mt-2"
      >
        Sauvegarder
      </button>
    </div>
  </div>

  <!-- Flatpickr JS -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <script>
    /***********************************************************/
    /***               Variables globales                  ***/
    /***********************************************************/
    const PASSWORD = "admin12345";
    const BACKUP_URL = "https://script.google.com/macros/s/AKfycbw2Qcf_fO3d1LKkYb6adradD2v2G8iyFMSDdn7z5E4IRDiDIVcXUefiKXbJx8GufU7x/exec";
    let BACKUP_INTERVAL_MS = 1000 * 60 * 60 * 24; // 24h

    /***********************************************************/
    /***                 Gestion du login                    ***/
    /***********************************************************/
    function showLogin() {
      document.getElementById("login-overlay").style.display = "flex";
    }
    function hideLogin() {
      document.getElementById("login-overlay").style.display = "none";
    }
    function logout() {
      localStorage.removeItem("crm_logged_in");
      hideContent();
      showLogin();
    }
    function hideContent() {
      document.querySelector("header").style.display = "none";
      document.querySelector("nav").style.display = "none";
      document.querySelector("main").style.display = "none";
      document.getElementById("logout-btn").style.display = "none";
    }
    function showContent() {
      document.querySelector("header").style.display = "flex";
      document.querySelector("nav").style.display = "flex";
      document.querySelector("main").style.display = "flex";
      document.getElementById("logout-btn").style.display = "block";
    }

    document.getElementById("login-submit").addEventListener("click", () => {
      const pwd = document.getElementById("login-password").value;
      const remember = document.getElementById("login-remember").checked;
      if (pwd === PASSWORD) {
        if (remember) {
          localStorage.setItem("crm_logged_in", "true");
        }
        hideLogin();
        showContent();
      } else {
        alert("Mot de passe incorrect.");
      }
      document.getElementById("login-password").value = "";
    });
    document.getElementById("logout-btn").addEventListener("click", logout);

    /***********************************************************/
    /***             D√©marrage apr√®s DOM loaded               ***/
    /***********************************************************/
    window.addEventListener("DOMContentLoaded", () => {
      // V√©rifier si d√©j√† connect√©
      if (localStorage.getItem("crm_logged_in") === "true") {
        hideLogin();
        showContent();
      } else {
        hideContent();
        showLogin();
      }

      // Attacher navigation d'onglets
      tabs.forEach((item, idx) => {
        const btnEl = document.getElementById(item.btn);
        if (btnEl) {
          btnEl.addEventListener("click", () => switchTab(idx));
        }
      });
      // Onglet par d√©faut
      switchTab(0);

      // Initialiser footer ann√©e
      document.getElementById("footer-year").textContent = new Date().getFullYear();

      // Rendu initial des onglets
      renderPerformance();
      renderVisite();
      initializeCalculatrice();
      initializeGraphGarantie();

      // Programmer le backup automatique
      schedulePeriodicBackup();
    });

    /***********************************************************/
    /***           Fonctions de stockage local               ***/
    /***********************************************************/
    function getCurrentYear() {
      return new Date().getFullYear().toString();
    }
    function loadAllData() {
      const raw = localStorage.getItem("crm_data");
      return raw ? JSON.parse(raw) : {};
    }
    function saveAllData(obj) {
      localStorage.setItem("crm_data", JSON.stringify(obj));
      // D√®s qu'on met √† jour crm_data, on envoie un backup
      backupToGoogleDrive();
    }
    function loadDealers() {
      const all = loadAllData();
      const yr = getCurrentYear();
      if (!all[yr]) {
        all[yr] = [];
        saveAllData(all);
      }
      return all[yr];
    }
    function saveDealers(arr) {
      const all = loadAllData();
      const yr = getCurrentYear();
      all[yr] = arr;
      saveAllData(all);
    }
    function createDealer() {
      return {
        id: Date.now().toString(36) + Math.random().toString(36).slice(2),
        name: "",
        taux: "",
        mois: Array(12).fill(""),
        moyennePrevYear: "",
        visits: [],
        notes: [],
        priority: "1",
        info: {
          proprietaire: "",
          email_proprietaire: "",
          comptabilite: "",
          email_comptabilite: "",
          fni: "",
          dir_service: "",
          email_dir_service: "",
          directeurs_financiers: []
        }
      };
    }

    /***********************************************************/
    /***      Sauvegarde automatique vers Google Drive       ***/
    /***********************************************************/
    function backupToGoogleDrive() {
      const data = localStorage.getItem("crm_data") || "{}";
      fetch(BACKUP_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ data: data })
      })
        .then(response => response.json())
        .then(json => {
          if (json.status && json.status === "ok") {
            console.log("üì¶ Backup envoy√© sur Google Drive avec succ√®s");
          } else {
            console.warn("‚ö†Ô∏è Backup partiellement envoy√©, statut:", json);
          }
        })
        .catch(err => {
          console.error("‚ùå Erreur lors de l'envoi du backup :", err);
        });
    }
    function schedulePeriodicBackup() {
      setInterval(() => {
        console.log("‚è∞ Envoi de backup quotidien");
        backupToGoogleDrive();
      }, BACKUP_INTERVAL_MS);
    }

    /***********************************************************/
    /***              Fonctions utilitaires                   ***/
    /***********************************************************/
    function totalAnnual(arr) {
      return (arr || []).reduce((sum, v) => {
        if (v === "" || v === "-") return sum;
        const n = parseFloat(v.toString().replace(/\s/g, ""));
        return sum + (isNaN(n) ? 0 : n);
      }, 0);
    }
    function averageMonthly(arr) {
      const filtered = (arr || []).filter(v => {
        if (!v) return false;
        if (v === "") return false;
        if (v === "-") return false;
        const n = parseFloat(v.toString().replace(/\s/g, ""));
        return !isNaN(n);
      });
      if (!filtered.length) return 0;
      const sum = filtered.reduce((acc, v) => {
        const n = parseFloat(v.toString().replace(/\s/g, ""));
        return acc + (isNaN(n) ? 0 : n);
      }, 0);
      return sum / filtered.length;
    }
    function getClaimColor(val) {
      const num = parseFloat(val);
      if (isNaN(num)) return "chip-gray";
      if (num < 30) return "chip-green";
      if (num <= 40) return "chip-yellow";
      return "chip-red";
    }
    function daysSince(dateStr) {
      if (!dateStr) return "-";
      const d = new Date(dateStr);
      if (isNaN(d)) return "-";
      const now = new Date();
      const diff = Math.floor((now - d) / (1000 * 60 * 60 * 24));
      return diff >= 0 ? diff : "-";
    }
    function getDaysColorClass(days) {
      const n = parseInt(days);
      if (isNaN(n) || days === "-") return "";
      if (n <= 30) return "bg-green-100 text-green-800 border-green-200";
      if (n <= 60) return "bg-yellow-100 text-yellow-800 border-yellow-200";
      return "bg-red-100 text-red-800 border-red-200";
    }

    /***********************************************************/
    /***                Navigation d‚Äôonglets                  ***/
    /***********************************************************/
    const tabs = [
      { btn: "tab-accueil-btn", tab: "tab-accueil" },
      { btn: "tab-performance-btn", tab: "tab-performance" },
      { btn: "tab-visite-btn", tab: "tab-visite" },
      { btn: "tab-calc-btn", tab: "tab-calc" },
      { btn: "tab-garantie-btn", tab: "tab-garantie" },
      { btn: "tab-livraison-btn", tab: "tab-livraison" }
    ];
    function switchTab(index) {
      tabs.forEach((item, i) => {
        document.getElementById(item.tab).classList.toggle("hidden", i !== index);
        document.getElementById(item.btn).classList.toggle("nav-active", i === index);
      });
      window.scrollTo({ top: 0, behavior: "smooth" });

      if (index === 1) renderPerformance();
      if (index === 2) renderVisite();
      if (index === 4) drawGraph();
    }

    /***********************************************************/
    /***           Onglet ‚ÄúSuivi performance mensuelle‚Äù       ***/
    /***********************************************************/
    function renderPerformance() {
      const currentYear = parseInt(getCurrentYear());
      const prevYear = currentYear - 1;
      let search = document.getElementById("search-performance").value.trim().toLowerCase();
      let dealers = loadDealers().slice().sort((a, b) =>
        (a.name || "").localeCompare(b.name || "")
      );
      if (search) {
        dealers = dealers.filter(d =>
          (d.name || "").toLowerCase().includes(search)
        );
      }

      let html = `
        <table class="crm-table">
          <thead>
            <tr>
              <th style="min-width:32px">#</th>
              <th style="min-width:48px">Info</th>
              <th style="min-width:120px">Nom</th>
              <th style="min-width:60px">Taux</th>
              <th style="min-width:70px">Janv</th>
              <th style="min-width:70px">F√©v</th>
              <th style="min-width:70px">Mars</th>
              <th style="min-width:70px">Avr</th>
              <th style="min-width:70px">Mai</th>
              <th style="min-width:70px">Juin</th>
              <th style="min-width:70px">Juil</th>
              <th style="min-width:70px">Ao√ªt</th>
              <th style="min-width:70px">Sept</th>
              <th style="min-width:70px">Oct</th>
              <th style="min-width:70px">Nov</th>
              <th style="min-width:70px">D√©c</th>
              <th style="min-width:84px">Total ${currentYear}</th>
              <th style="min-width:84px">Moyenne ${currentYear}</th>
              <th style="min-width:100px">Moyenne ${prevYear}</th>
              <th style="min-width:80px">% Diff ${prevYear}‚Äì${currentYear}</th>
              <th style="min-width:60px">Notes</th>
              <th style="min-width:48px"></th>
            </tr>
          </thead>
          <tbody>
      `;

      let idx = 0;
      dealers.forEach(d => {
        idx++;
        const moisArr = d.mois || [];
        const totCurYear = Math.round(totalAnnual(moisArr));
        const moyCurYearNum = Math.round(averageMonthly(moisArr));
        const moyPrevYearNum = parseFloat(d.moyennePrevYear) || 0;
        const moyPrevYear = Math.round(moyPrevYearNum);
        let diffPct = "0.0";
        if (moyPrevYearNum !== 0) {
          diffPct = (
            (moyCurYearNum - moyPrevYearNum) /
            moyPrevYearNum *
            100
          ).toFixed(1);
        }
        const pctColor = parseFloat(diffPct) >= 0 ? "chip-green" : "chip-red";
        const totFmt = totCurYear.toLocaleString("fr-FR");
        const moyCurFmt = moyCurYearNum.toLocaleString("fr-FR");
        const moyPrevFmt = moyPrevYear.toLocaleString("fr-FR");

        html += `
          <tr data-id="${d.id}" class="hover:bg-gray-50 transition-all">
            <td>${idx}</td>
            <td>
              <button
                onclick="openInfo('${d.id}')"
                class="text-blue-600 hover:underline font-semibold text-sm"
                tabindex="0"
              >‚ÑπÔ∏è</button>
            </td>
            <td>
              <input
                type="text"
                value="${d.name || ""}"
                class="border-b border-gray-300 focus:border-red-500 px-1 w-full bg-white text-center"
                onchange="updateNameById('${d.id}', this.value)"
                tabindex="1"
              />
            </td>
            <td>
              <div style="display:inline-flex;align-items:center;gap:0.2em;">
                <input
                  type="number"
                  value="${d.taux || ""}"
                  class="chip ${getClaimColor(d.taux)}"
                  style="font-size:0.9rem; padding:2px 4px; width:42px; min-width:42px; text-align:center;"
                  onchange="updateTauxById('${d.id}', this.value)"
                  tabindex="0"
                />
                <span class="font-bold text-gray-400" style="font-size:0.85rem;">%</span>
              </div>
            </td>
        `;

        // Colonnes mois (12 colonnes)
        for (let m = 0; m < 12; m++) {
          let rawVal = moisArr[m] != null ? moisArr[m] : "";
          let displayed = rawVal === 0 ? "0" : rawVal.toString();
          html += `
            <td>
              <div style="display:inline-flex;align-items:center;gap:0.2em;">
                <input
                  type="text"
                  class="border-b border-gray-300 focus:border-red-500 px-1 bg-white w-16 text-right"
                  value="${displayed}"
                  onchange="updateMonthValue('${d.id}', ${m}, this.value)"
                  placeholder="-"
                  tabindex="${2 + (m + (idx - 1) * 14)}"
                />
                <span class="font-bold text-gray-400" style="font-size:0.85rem">$</span>
              </div>
            </td>
          `;
        }

        // Total de l‚Äôann√©e en cours
        html += `
          <td>
            <span class="chip chip-blue">${totFmt}
              <span class="font-bold text-gray-400" style="font-size:0.85rem">$</span>
            </span>
          </td>
        `;
        // Moyenne de l‚Äôann√©e en cours
        html += `
          <td>
            <span class="chip chip-yellow">${moyCurFmt}
              <span class="font-bold text-gray-400" style="font-size:0.85rem">$</span>
            </span>
          </td>
        `;
        // Moyenne de l‚Äôann√©e pr√©c√©dente (input)
        html += `
          <td>
            <div style="display:inline-flex;align-items:center;gap:0.2em;">
              <input
                type="number"
                value="${moyPrevYear || ""}"
                class="border-b border-gray-300 focus:border-red-500 px-1 bg-white w-16 text-right"
                onchange="updatePrevYearAverage('${d.id}', this.value)"
                tabindex="${2 + 12 + (idx - 1) * 14}"
              />
              <span class="font-bold text-gray-400" style="font-size:0.85rem">$</span>
            </div>
          </td>
        `;
        // % Diff (pastille)
        html += `
          <td>
            <span class="chip ${pctColor}">
              ${parseFloat(diffPct) >= 0 ? "+" : ""}${diffPct}%
            </span>
          </td>
        `;
        // Bouton Notes
        html += `
          <td>
            <button
              onclick="openNotes('${d.id}')"
              class="text-blue-600 hover:underline font-semibold text-sm"
              tabindex="0"
            >üìù</button>
          </td>
        `;
        // Bouton Supprimer
        html += `
          <td>
            <button
              onclick="removeDealer('${d.id}')"
              class="text-red-600 hover:underline font-bold text-xs"
              tabindex="0"
            >X</button>
          </td>
        `;
        html += `</tr>`;
      });

      // Ligne Totaux / Moyennes globales
      let totalsArray = Array(12).fill(0);
      let sumMoyCur = 0, countMoyCur = 0;
      let sumMoyPrev = 0, countMoyPrev = 0;

      dealers.forEach(d => {
        (d.mois || []).forEach((v, i) => {
          if (v !== "" && v !== "-") {
            const n = parseFloat(v.toString().replace(/\s/g, ""));
            if (!isNaN(n)) totalsArray[i] += n;
          }
        });
        const mCur = Math.round(averageMonthly(d.mois || []));
        if (!isNaN(mCur)) {
          sumMoyCur += mCur;
          countMoyCur++;
        }
        const mPrev = Math.round(parseFloat(d.moyennePrevYear) || 0);
        if (!isNaN(mPrev)) {
          sumMoyPrev += mPrev;
          countMoyPrev++;
        }
      });

      const totalYearSum = totalsArray.reduce((a, b) => a + b, 0);
      const avgCurYear = countMoyCur ? Math.round(sumMoyCur / countMoyCur) : 0;
      const avgPrevYear = countMoyPrev ? Math.round(sumMoyPrev / countMoyPrev) : 0;
      let diffPctGlobal = "0.0";
      if (avgPrevYear !== 0) {
        diffPctGlobal = (
          (avgCurYear - avgPrevYear) / avgPrevYear * 100
        ).toFixed(1);
      }
      const pctColorGlobal =
        parseFloat(diffPctGlobal) >= 0 ? "chip-green" : "chip-red";

      const totalYearFmt = totalYearSum.toLocaleString("fr-FR");
      const avgCurFmt = avgCurYear.toLocaleString("fr-FR");
      const avgPrevFmt = avgPrevYear.toLocaleString("fr-FR");

      const colTotalsHTML = totalsArray
        .map(val => {
          const f = val.toLocaleString("fr-FR");
          return `
          <td class="px-1 py-1 bg-gray-50">
            <span class="chip chip-yellow">
              ${f}<span class="font-bold text-gray-400" style="font-size:0.85rem">$</span>
            </span>
          </td>`;
        })
        .join("");

      const totalRow = `
        <tr class="bg-gray-50 font-semibold">
          <td colspan="3" class="text-right">Totaux / Moyennes :</td>
          <td></td>
          ${colTotalsHTML}
          <td>
            <span class="chip chip-blue">${totalYearFmt}
              <span class="font-bold text-gray-400" style="font-size:0.85rem">$</span>
            </span>
          </td>
          <td>
            <span class="chip chip-yellow">${avgCurFmt}
              <span class="font-bold text-gray-400" style="font-size:0.85rem">$</span>
            </span>
          </td>
          <td>
            <div style="display:inline-flex;align-items:center;gap:0.2em;">
              ${avgPrevFmt}<span class="font-bold text-gray-400" style="font-size:0.85rem">$</span>
            </div>
          </td>
          <td>
            <span class="chip ${pctColorGlobal}">
              ${parseFloat(diffPctGlobal) >= 0 ? "+" : ""}${diffPctGlobal}%
            </span>
          </td>
          <td colspan="2"></td>
        </tr>
      `;
      html += totalRow + "</tbody></table>";
      document.getElementById("performance-table-container").innerHTML = html;
    }

    function updateNameById(id, val) {
      const arr = loadDealers();
      const d = arr.find(e => e.id === id);
      if (d) d.name = val.trim();
      saveDealers(arr);
      renderPerformance();
      renderVisite();
    }
    function updateTauxById(id, val) {
      const arr = loadDealers();
      const d = arr.find(e => e.id === id);
      if (d) d.taux = val !== "" ? +val : "";
      saveDealers(arr);
      renderPerformance();
      renderVisite();
    }
    function updateMonthValue(id, monthIndex, rawValue) {
      const arr = loadDealers();
      const d = arr.find(e => e.id === id);
      if (!d) return;
      const v = rawValue.trim();
      if (v === "-") {
        d.mois[monthIndex] = "-";
      } else {
        const cleaned = v.replace(/\s/g, "");
        const num = parseFloat(cleaned);
        if (!isNaN(num) && num >= 0) {
          d.mois[monthIndex] = Math.round(num).toString();
        } else {
          d.mois[monthIndex] = "";
        }
      }
      saveDealers(arr);
      renderPerformance();
      renderVisite();
    }
    function updatePrevYearAverage(id, val) {
      const arr = loadDealers();
      const d = arr.find(e => e.id === id);
      if (d) {
        const num = parseFloat(val);
        d.moyennePrevYear = isNaN(num) ? "" : Math.round(num);
      }
      saveDealers(arr);
      renderPerformance();
      renderVisite();
    }
    function removeDealer(id) {
      if (confirm("Supprimer ce concessionnaire ?")) {
        let arr = loadDealers().filter(e => e.id !== id);
        saveDealers(arr);
        renderPerformance();
        renderVisite();
      }
    }
    document.getElementById("btn-add-row")?.addEventListener("click", () => {
      const arr = loadDealers();
      arr.push(createDealer());
      saveDealers(arr);
      renderPerformance();
      renderVisite();
    });
    document.getElementById("btn-export-excel")?.addEventListener("click", () => {
      exportToExcel();
    });
    document.getElementById("search-performance")?.addEventListener("input", renderPerformance);
    document.getElementById("btn-new-year")?.addEventListener("click", () => {
      if (
        !confirm(
          "Voulez-vous r√©ellement d√©marrer une nouvelle ann√©e ? (tous les chiffres mensuels seront remis √† z√©ro.)"
        )
      ) {
        return;
      }
      const arr = loadDealers();
      arr.forEach(d => {
        d.mois = Array(12).fill("");
        d.moyennePrevYear = "";
      });
      saveDealers(arr);
      renderPerformance();
      renderVisite();
      alert("Nouvelle ann√©e d√©marr√©e : tous les champs mensuels sont remis √† z√©ro.");
    });

    function exportToExcel() {
      const dealers = loadDealers();
      const currentYear = parseInt(getCurrentYear());
      const prevYear = currentYear - 1;

      const header = ["#", "Nom", "Taux"];
      ["Janv","F√©v","Mars","Avr","Mai","Juin","Juil","Ao√ªt","Sept","Oct","Nov","D√©c"].forEach(m => header.push(m));
      header.push(
        `Total ${currentYear}`,
        `Moyenne ${currentYear}`,
        `Moyenne ${prevYear}`,
        `% Diff ${prevYear}-${currentYear}`,
        "Notes historique"
      );

      const ws_data = [header];
      dealers.forEach((d, idx) => {
        const row = [idx + 1, d.name, d.taux];
        (d.mois || Array(12).fill("")).forEach(v => {
          if (v === "" || v === "-") {
            row.push("");
          } else {
            const n = parseFloat(v.toString().replace(/\s/g, ""));
            row.push(isNaN(n) ? "" : Math.round(n));
          }
        });
        const totCur = Math.round(totalAnnual(d.mois || []));
        const moyCur = Math.round(averageMonthly(d.mois || []));
        const moyPrev = Math.round(parseFloat(d.moyennePrevYear) || 0);
        let diffPct = "0.0";
        if (moyPrev !== 0) {
          diffPct = ((moyCur - moyPrev) / moyPrev * 100).toFixed(1);
        }
        row.push(totCur, moyCur, moyPrev, diffPct + "%");
        const notesText = (d.notes || [])
          .map(n => `${n.date} ‚Äì ${n.text}`)
          .join(" ; ");
        row.push(notesText);
        ws_data.push(row);
      });
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(ws_data);
      XLSX.utils.book_append_sheet(wb, ws, `Perf_${currentYear}`);
      XLSX.writeFile(wb, `suivi_performance_${currentYear}.xlsx`);
    }

    /***********************************************************/
    /***    Ajout du traitement pour l'import Excel/CSV      ***/
    /***********************************************************/
    // Ouvre le selecteur de fichier quand on clique sur "Importer Excel/CSV"
    document.getElementById("btn-import")?.addEventListener("click", () => {
      document.getElementById("file-input").click();
    });

    // √âcoute le changement de fichier et traite l'import
    document.getElementById("file-input")?.addEventListener("change", handleImportFile, false);

    function handleImportFile(evt) {
      const input = evt.target;
      if (!input.files || !input.files[0]) return;

      const file = input.files[0];
      const reader = new FileReader();

      reader.onload = function(e) {
        const data = e.target.result;
        let workbook;
        try {
          // Lire le fichier au format binaire avec XLSX
          workbook = XLSX.read(data, { type: "binary" });
        } catch (err) {
          alert("Erreur lors de la lecture du fichier Excel : " + err.message);
          return;
        }

        // On prend la premi√®re feuille
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        // Convertir en tableau d'objets JSON
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

        // Mapping vers la structure interne
        const importedDealers = jsonData.map(row => {
          const d = createDealer();
          d.name = row["Nom"]?.toString().trim() || "";
          d.taux = parseFloat(row["Taux"]) || "";
          // Colonnes mois attendues : Janv, F√©v, etc.
          const moisCl√©s = ["Janv", "F√©v", "Mars", "Avr", "Mai", "Juin", "Juil", "Ao√ªt", "Sept", "Oct", "Nov", "D√©c"];
          d.mois = moisCl√©s.map(key => {
            const v = row[key];
            const n = parseFloat(v);
            return isNaN(n) ? "" : Math.round(n).toString();
          });
          d.moyennePrevYear = parseFloat(row["MoyennePrevYear"]) ? Math.round(parseFloat(row["MoyennePrevYear"])) : "";
          return d;
        });

        // √âcrase les donn√©es courantes
        saveDealers(importedDealers);

        // Met √† jour l'affichage
        renderPerformance();
        renderVisite();

        // R√©initialise l'input pour pouvoir r√©-importer si besoin
        input.value = "";
        alert("Importation termin√©e : " + importedDealers.length + " concessionnaire(s) charg√©(s).");
      };

      // Lire en binaire
      reader.readAsBinaryString(file);
    }

    /***********************************************************/
    /***            Onglet ‚ÄúVisite concessionnaire‚Äù           ***/
    /***********************************************************/
    function renderVisite() {
      let search = document.getElementById("search-visite").value.trim().toLowerCase();
      let dealers = loadDealers().slice();
      dealers.sort((a, b) => {
        const ma = Math.round(averageMonthly(a.mois || [])) || 0;
        const mb = Math.round(averageMonthly(b.mois || [])) || 0;
        return mb - ma;
      });
      if (search) {
        dealers = dealers.filter(d => (d.name || "").toLowerCase().includes(search));
      }
      let html = `
        <table class="crm-table w-full">
          <thead class="bg-gray-50">
            <tr>
              <th style="min-width:80px">Taux (%)</th>
              <th>Concessionnaire</th>
              <th style="min-width:120px">Moyenne ${getCurrentYear()} ($)</th>
              <th style="min-width:160px">Visites</th>
              <th style="min-width:100px">Jours depuis</th>
              <th style="min-width:100px">Agenda</th>
              <th style="min-width:100px">Note</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
      `;

      dealers.forEach(d => {
        const moyCurYear = Math.round(averageMonthly(d.mois || []));
        const moyFmt = moyCurYear.toLocaleString("fr-FR");
        const moyClass =
          moyCurYear > 15000
            ? "chip chip-green"
            : moyCurYear >= 5000
            ? "chip chip-yellow"
            : "chip chip-red";

        const visits = d.visits || [];
        const totalVisits = visits.length;
        const lastDate = totalVisits > 0 ? visits[visits.length - 1] : null;
        const days = lastDate ? daysSince(lastDate) : "-";
        const daysClass = getDaysColorClass(days);

        html += `
          <tr data-id="${d.id}">
            <td>
              <span class="chip ${getClaimColor(d.taux)}">
                ${d.taux || ""} <span class="font-bold text-gray-400">%</span>
              </span>
            </td>
            <td class="font-semibold text-md text-center">${d.name || ""}</td>
            <td class="text-center">
              <span class="${moyClass}">${moyFmt} $
              </span>
            </td>
            <td>
              <button
                class="bg-green-600 text-white px-2 py-1 rounded-lg shadow hover:bg-green-700 text-xs font-semibold"
                onclick="addVisitToday('${d.id}')"
                tabindex="0"
              >+ Aujourd‚Äôhui</button>
              <button
                class="bg-blue-600 text-white px-2 py-1 rounded-lg shadow hover:bg-blue-700 text-xs font-semibold mt-1"
                onclick="openDatePicker('${d.id}')"
                tabindex="0"
              >+ Date</button>
              <!-- Champ cach√© Flatpickr -->
              <input
                type="text"
                id="input-date-${d.id}"
                class="hidden-input"
                style="position:absolute; opacity:0; width:0; height:0; left:0; top:0;"
              />
              <div class="flex gap-1 flex-wrap mt-2 justify-center">
        `;
        if (totalVisits > 0) {
          const lastTwo = visits.slice(-2);
          lastTwo.forEach((v, i) => {
            const idxVisit = totalVisits - 2 + i;
            html += `
              <span class="bg-gray-200 rounded-full px-3 py-1 flex items-center gap-1 text-xs">
                ${formatDate(v)}
                <button
                  class="ml-1 text-red-600 hover:text-red-900 font-bold"
                  onclick="removeVisit('${d.id}', ${idxVisit})"
                >√ó</button>
              </span>
            `;
          });
          if (totalVisits > 2) {
            html += `
              <button
                class="bg-gray-300 rounded-full px-3 py-1 text-xs font-semibold hover:bg-gray-400"
                onclick="toggleAllVisits('${d.id}', this)"
                tabindex="0"
              >+${totalVisits - 2} autres</button>
            `;
          }
        } else {
          html += `<span class="text-gray-400 italic text-xs">Aucune visite</span>`;
        }
        html += `
              </div>
            </td>
            <td class="font-mono font-semibold ${daysClass}">${days}</td>
            <td>
              <button
                onclick="addToGoogleAgenda('${d.id}')"
                class="bg-orange-600 text-white px-2 py-1 rounded-lg shadow hover:bg-orange-700 text-xs font-semibold"
              >
                Agenda
              </button>
            </td>
            <td>
              <button
                onclick="openNotes('${d.id}')"
                class="text-blue-600 hover:underline font-semibold text-sm"
              >üìù</button>
            </td>
            <td>
              <button
                onclick="removeDealer('${d.id}')"
                class="text-red-600 hover:underline font-bold text-xs"
                tabindex="0"
              >Supprimer</button>
            </td>
          </tr>
        `;
      });
      html += `</tbody></table>`;
      document.getElementById("visite-table-container").innerHTML = html;

      // Initialiser Flatpickr sur chaque input-date-<id>
      const visitsInputs = document.querySelectorAll("[id^='input-date-']");
      visitsInputs.forEach(inp => {
        if (!inp._flatpickr) {
          const fp = flatpickr(inp, {
            dateFormat: "Y-m-d",
            allowInput: false,
            onChange: function(selectedDates, dateStr) {
              if (selectedDates.length) {
                manualVisitDateChosen(inp.id.replace("input-date-", ""), dateStr);
              }
            }
          });
          inp._flatpickr = fp;
        }
      });
    }

    function addVisitToday(id) {
      const arr = loadDealers();
      const d = arr.find(e => e.id === id);
      if (d) {
        const today = new Date().toISOString().split("T")[0];
        d.visits.push(today);
        saveDealers(arr);
        renderVisite();
        renderPerformance();
      }
    }
    function openDatePicker(id) {
      const input = document.getElementById(`input-date-${id}`);
      if (input && input._flatpickr) {
        input._flatpickr.open();
      }
    }
    function manualVisitDateChosen(id, dateStr) {
      if (dateStr && !isNaN(new Date(dateStr))) {
        const arr = loadDealers();
        const d = arr.find(e => e.id === id);
        if (d) {
          d.visits.push(dateStr);
          saveDealers(arr);
          renderVisite();
          renderPerformance();
        }
      }
    }
    function removeVisit(id, idx) {
      const arr = loadDealers();
      const d = arr.find(e => e.id === id);
      if (d && d.visits) {
        d.visits.splice(idx, 1);
        saveDealers(arr);
        renderVisite();
        renderPerformance();
      }
    }
    function toggleAllVisits(id, btn) {
      const existing = document.querySelector("#dropdown-visits");
      if (existing) {
        existing.remove();
        return;
      }
      const arr = loadDealers();
      const d = arr.find(e => e.id === id);
      if (!d) return;
      const visits = d.visits || [];
      if (visits.length <= 2) return;
      let html = `
        <div id="dropdown-visits" class="absolute z-50 mt-2 bg-white shadow-lg rounded-lg p-3 border flex flex-col gap-1" style="min-width:200px; right:0;">
      `;
      visits.slice(0, -2).forEach((v, i) => {
        html += `
          <div class="flex items-center gap-2 mb-1 bg-gray-50 rounded-full px-2 py-1 text-xs">
            ${formatDate(v)}
            <button
              class="ml-2 text-red-600 hover:text-red-900 font-bold"
              onclick="removeVisit('${id}', ${i}); event.stopPropagation();"
            >√ó</button>
          </div>
        `;
      });
      html += `<div class="text-center text-xs text-gray-500 pt-1">Cliquer en dehors pour fermer</div></div>`;
      const pop = document.createElement("div");
      pop.innerHTML = html;
      document.body.appendChild(pop.firstChild);
      function close() {
        document.getElementById("dropdown-visits")?.remove();
        document.body.removeEventListener("click", close, true);
      }
      setTimeout(() => document.body.addEventListener("click", close, true), 100);
    }
    document.getElementById("search-visite")?.addEventListener("input", renderVisite);

    function formatDate(dateStr) {
      if (!dateStr) return "";
      const d = new Date(dateStr);
      if (isNaN(d)) return "";
      return d.toLocaleDateString("fr-CA");
    }
    function addToGoogleAgenda(id) {
      const now = new Date();
      function pad(n) {
        return String(n).padStart(2, "0");
      }
      const yyyy = now.getUTCFullYear();
      const mm = pad(now.getUTCMonth() + 1);
      const dd = pad(now.getUTCDate());
      const hh = pad(now.getUTCHours());
      const mi = pad(now.getUTCMinutes());
      const ss = pad(now.getUTCSeconds());
      const start = `${yyyy}${mm}${dd}T${hh}${mi}${ss}Z`;
      const later = new Date(now.getTime() + 60 * 60 * 1000);
      const h2 = pad(later.getUTCHours());
      const m2 = pad(later.getUTCMinutes());
      const s2 = pad(later.getUTCSeconds());
      const end = `${yyyy}${mm}${dd}T${h2}${m2}${s2}Z`;

      const arr = loadDealers();
      const d = arr.find(e => e.id === id);
      const title = encodeURIComponent(d ? `Visite : ${d.name}` : "Visite concessionnaire");
      const details = encodeURIComponent("Visite enregistr√©e via CRM.");
      const url = `https://calendar.google.com/calendar/r/eventedit?text=${title}&dates=${start}/${end}&details=${details}&sf=true`;
      window.open(url, "_blank");
    }

    /***********************************************************/
    /***                Popup Notes & Infos                   ***/
    /***********************************************************/
    function openNotes(id) {
      const overlay = document.getElementById("notes-overlay");
      const titleEl = document.getElementById("notes-title");
      const listEl = document.getElementById("notes-list");
      const textarea = document.getElementById("notes-input");
      const addBtn = document.getElementById("btn-add-note");
      const exportBtn = document.getElementById("btn-export-notes");

      const arr = loadDealers();
      const d = arr.find(e => e.id === id);
      if (!d) return;

      titleEl.textContent = `Notes : ${d.name}`;
      listEl.innerHTML = "";
      d.notes = d.notes || [];
      d.notes.sort((a, b) => new Date(b.date) - new Date(a.date));
      d.notes.forEach((n, i) => {
        const div = document.createElement("div");
        div.className = "note-item";
        div.innerHTML = `
          <div class="note-date">${n.date}</div>
          <div class="note-text">${n.text}</div>
          <button class="ml-2 text-red-600 hover:text-red-900 font-bold" onclick="deleteNote('${d.id}', ${i})">√ó</button>
        `;
        listEl.appendChild(div);
      });
      textarea.value = "";
      addBtn.onclick = () => addNote(id);
      exportBtn.onclick = () => exportNotesDocx(id);
      overlay.style.display = "flex";
    }
    function openInfo(id) {
      const overlay = document.getElementById("info-overlay");
      const titleEl = document.getElementById("info-title");
      const ownerInput = document.getElementById("info-owner");
      const ownerEmailInput = document.getElementById("info-owner-email");
      const accountsInput = document.getElementById("info-accounts");
      const accountsEmailInput = document.getElementById("info-accounts-email");
      const fniInput = document.getElementById("info-fni");
      const dirServiceInput = document.getElementById("info-dir");
      const dirServiceEmailInput = document.getElementById("info-dir-email");
      const df1Input = document.getElementById("info-df1");
      const df1EmailInput = document.getElementById("info-df1-email");
      const df2Input = document.getElementById("info-df2");
      const df2EmailInput = document.getElementById("info-df2-email");
      const df3Input = document.getElementById("info-df3");
      const df3EmailInput = document.getElementById("info-df3-email");
      const saveBtn = document.getElementById("btn-save-info");

      const arr = loadDealers();
      const d = arr.find(e => e.id === id);
      if (!d) return;
      titleEl.textContent = `Infos : ${d.name}`;
      ownerInput.value = d.info.proprietaire || "";
      ownerEmailInput.value = d.info.email_proprietaire || "";
      accountsInput.value = d.info.comptabilite || "";
      accountsEmailInput.value = d.info.email_comptabilite || "";
      fniInput.value = d.info.fni || "";
      dirServiceInput.value = d.info.dir_service || "";
      dirServiceEmailInput.value = d.info.email_dir_service || "";

      const dfs = d.info.directeurs_financiers || [];
      df1Input.value = dfs[0]?.nom || "";
      df1EmailInput.value = dfs[0]?.email || "";
      df2Input.value = dfs[1]?.nom || "";
      df2EmailInput.value = dfs[1]?.email || "";
      df3Input.value = dfs[2]?.nom || "";
      df3EmailInput.value = dfs[2]?.email || "";

      saveBtn.onclick = () => saveInfo(id);
      overlay.style.display = "flex";
    }
    function closeNotes() {
      document.getElementById("notes-overlay").style.display = "none";
      document.getElementById("info-overlay").style.display = "none";
    }
    function addNote(id) {
      const textarea = document.getElementById("notes-input");
      const text = textarea.value.trim();
      if (!text) return;
      const date = new Date().toISOString().split("T")[0];
      const arr = loadDealers();
      const d = arr.find(e => e.id === id);
      if (d) {
        d.notes = d.notes || [];
        d.notes.unshift({ date, text });
        saveDealers(arr);
        openNotes(id);
      }
    }
    function deleteNote(id, idx) {
      const arr = loadDealers();
      const d = arr.find(e => e.id === id);
      if (d && d.notes) {
        d.notes.splice(idx, 1);
        saveDealers(arr);
        openNotes(id);
      }
    }
    async function exportNotesDocx(id) {
      const { Document, Packer, Paragraph, TextRun } = docx;
      const arr = loadDealers();
      const d = arr.find(e => e.id === id);
      if (!d || !d.notes || !d.notes.length) {
        alert("Pas de notes √† exporter.");
        return;
      }
      const doc = new Document({
        sections: [
          {
            properties: {},
            children: [
              new Paragraph({
                children: [
                  new TextRun({
                    text: `Notes pour ${d.name}`,
                    bold: true,
                    size: 32
                  })
                ]
              }),
              ...d.notes.map(n =>
                new Paragraph({
                  children: [
                    new TextRun({
                      text: `${n.date} ‚Äì `,
                      bold: true,
                      size: 24
                    }),
                    new TextRun({
                      text: n.text,
                      size: 24
                    })
                  ]
                })
              )
            ]
          }
        ]
      });
      Packer.toBlob(doc).then(blob => {
        const fileName = `Notes_${d.name.replace(/\s+/g, "_")}.docx`;
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = fileName;
        link.click();
        URL.revokeObjectURL(link.href);
      });
    }
    function saveInfo(id) {
      const ownerInput = document.getElementById("info-owner");
      const ownerEmailInput = document.getElementById("info-owner-email");
      const accountsInput = document.getElementById("info-accounts");
      const accountsEmailInput = document.getElementById("info-accounts-email");
      const fniInput = document.getElementById("info-fni");
      const dirServiceInput = document.getElementById("info-dir");
      const dirServiceEmailInput = document.getElementById("info-dir-email");
      const df1Input = document.getElementById("info-df1");
      const df1EmailInput = document.getElementById("info-df1-email");
      const df2Input = document.getElementById("info-df2");
      const df2EmailInput = document.getElementById("info-df2-email");
      const df3Input = document.getElementById("info-df3");
      const df3EmailInput = document.getElementById("info-df3-email");

      const arr = loadDealers();
      const d = arr.find(e => e.id === id);
      if (d) {
        d.info.proprietaire = ownerInput.value.trim();
        d.info.email_proprietaire = ownerEmailInput.value.trim();
        d.info.comptabilite = accountsInput.value.trim();
        d.info.email_comptabilite = accountsEmailInput.value.trim();
        d.info.fni = fniInput.value.trim();
        d.info.dir_service = dirServiceInput.value.trim();
        d.info.email_dir_service = dirServiceEmailInput.value.trim();

        const dfArray = [];
        if (df1Input.value.trim() || df1EmailInput.value.trim()) {
          dfArray.push({ nom: df1Input.value.trim(), email: df1EmailInput.value.trim() });
        }
        if (df2Input.value.trim() || df2EmailInput.value.trim()) {
          dfArray.push({ nom: df2Input.value.trim(), email: df2EmailInput.value.trim() });
        }
        if (df3Input.value.trim() || df3EmailInput.value.trim()) {
          dfArray.push({ nom: df3Input.value.trim(), email: df3EmailInput.value.trim() });
        }
        d.info.directeurs_financiers = dfArray;

        saveDealers(arr);
        closeNotes();
      }
    }
    function navigateToGmail(inputId) {
      const email = document.getElementById(inputId).value.trim();
      if (email) {
        window.location.href = `mailto:${email}`;
      }
    }

    /***********************************************************/
    /***               Calculatrice financi√®re               ***/
    /***********************************************************/
    function calcAmortissement(montant, tauxAnnuel, annees) {
      if (montant > 0 && tauxAnnuel > 0 && annees > 0) {
        const mois = annees * 12;
        const tauxMensuel = tauxAnnuel / 12 / 100;
        const mensualite =
          (montant * tauxMensuel) / (1 - Math.pow(1 + tauxMensuel, -mois));
        const totalPaye = mensualite * mois;
        return totalPaye - montant;
      }
      return 0;
    }
    function updateCompInterest() {
      const montant = parseFloat(document.getElementById("comp-montant").value) || 0;
      const tauxAnnuel =
        parseFloat(document.getElementById("comp-taux").value) || 0;
      const annees = parseInt(document.getElementById("comp-annees").value) || 0;
      let interetGagne = 0;
      if (montant > 0 && tauxAnnuel > 0 && annees > 0) {
        const montantFinal = montant * Math.pow(1 + tauxAnnuel / 100, annees);
        interetGagne = montantFinal - montant;
        interetGagne = Math.round(interetGagne);
        document.getElementById("comp-total").textContent =
          interetGagne.toLocaleString("fr-CA", {
            style: "currency",
            currency: "CAD",
            maximumFractionDigits: 0
          });
      } else {
        document.getElementById("comp-total").textContent = "0 $";
      }
      return interetGagne;
    }
    function updateEmpInterest() {
      const montant = parseFloat(document.getElementById("emp-montant").value) || 0;
      const tauxAnnuel =
        parseFloat(document.getElementById("emp-taux").value) || 0;
      const annees = parseInt(document.getElementById("emp-annees").value) || 0;
      let interetsPayes = 0;
      if (montant > 0 && tauxAnnuel > 0 && annees > 0) {
        interetsPayes = calcAmortissement(montant, tauxAnnuel, annees);
        interetsPayes = Math.round(interetsPayes);
        document.getElementById("emp-total").textContent =
          interetsPayes.toLocaleString("fr-CA", {
            style: "currency",
            currency: "CAD",
            maximumFractionDigits: 0
          });
      } else {
        document.getElementById("emp-total").textContent = "0 $";
      }
      return interetsPayes;
    }
    function updateMargeInterest() {
      const montant = parseFloat(document.getElementById("marge-montant").value) || 0;
      const taux = parseFloat(document.getElementById("marge-taux").value) || 0;
      const annees = parseInt(document.getElementById("marge-annees").value) || 0;
      let interets = 0;
      if (montant > 0 && taux > 0 && annees > 0) {
        interets = calcAmortissement(montant, taux, annees);
        interets = Math.round(interets);
        document.getElementById("marge-total").textContent =
          interets.toLocaleString("fr-CA", {
            style: "currency",
            currency: "CAD",
            maximumFractionDigits: 0
          });
      } else {
        document.getElementById("marge-total").textContent = "0 $";
      }
      return interets;
    }
    function updatePretInterest() {
      const montant = parseFloat(document.getElementById("pret-montant").value) || 0;
      const taux = parseFloat(document.getElementById("pret-taux").value) || 0;
      const annees = parseInt(document.getElementById("pret-annees").value) || 0;
      let interets = 0;
      if (montant > 0 && taux > 0 && annees > 0) {
        interets = calcAmortissement(montant, taux, annees);
        interets = Math.round(interets);
        document.getElementById("pret-total").textContent =
          interets.toLocaleString("fr-CA", {
            style: "currency",
            currency: "CAD",
            maximumFractionDigits: 0
          });
      } else {
        document.getElementById("pret-total").textContent = "0 $";
      }
      return interets;
    }
    function updateAllCalc() {
      const compInteret = updateCompInterest();
      const empInteret = updateEmpInterest();
      const diff = compInteret - empInteret;
      let signe = "";
      if (diff > 0) signe = "+";
      document.getElementById("diff-box").textContent =
        `Diff√©rence entre les deux options : ${signe}${Math.round(diff).toLocaleString("fr-CA", { style: "currency", currency: "CAD", maximumFractionDigits: 0 })}`;

      const interetMarge = updateMargeInterest();
      const interetPret = updatePretInterest();
      const margeAnnees = parseInt(document.getElementById("marge-annees").value) || 0;
      let diffPer2Weeks = 0;
      if (margeAnnees > 0) diffPer2Weeks = (interetPret - interetMarge) / (margeAnnees * 26);
      diffPer2Weeks = Math.round(diffPer2Weeks);
      document.getElementById("compare-diff-per-two-weeks").textContent =
        `Diff√©rence aux deux semaines : ${diffPer2Weeks >= 0 ? "+" : ""}${diffPer2Weeks.toLocaleString("fr-CA", { style: "currency", currency: "CAD", maximumFractionDigits: 0 })}`;
    }
    function initializeCalculatrice() {
      [
        "comp-montant","comp-taux","comp-annees",
        "emp-montant","emp-taux","emp-annees",
        "marge-montant","marge-taux","marge-annees",
        "pret-montant","pret-taux","pret-annees"
      ].forEach(id => {
        document.getElementById(id)?.addEventListener("input", updateAllCalc);
      });
      updateAllCalc();
    }

    /***********************************************************/
    /***            Outil Visuel Garantie                     ***/
    /***********************************************************/
    const configG = {
      yearsMin: 0,
      yearsMax: 15,
      kmMin: 0,
      kmMax: 260000,
      stepYears: 1,
      stepKm: 20000,
      paddingLeft: 150,
      graphWidth: 760,
      graphHeight: 460
    };
    function initializeGraphGarantie() {
      const dateMise = document.getElementById("date-mise-en-service");
      const dateAuj = document.getElementById("date-aujourd‚Äôhui");
      const kmAuj = document.getElementById("km-aujourd‚Äôhui");
      const anneesProj = document.getElementById("annees-projetees");
      const kmPar = document.getElementById("km-par-an");

      ["input", "change"].forEach(ev => {
        dateMise?.addEventListener(ev, () => {
          updateKmProjete();
          drawGraph();
        });
        dateAuj?.addEventListener(ev, drawGraph);
        kmAuj?.addEventListener(ev, drawGraph);
        anneesProj?.addEventListener(ev, () => {
          updateKmProjete();
          drawGraph();
        });
        kmPar?.addEventListener(ev, () => {
          updateKmProjete();
          drawGraph();
        });
      });

      window.onload = function () {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, "0");
        const dd = String(today.getDate()).padStart(2, "0");
        if (dateMise && !dateMise.value) dateMise.value = "2023-01-01";
        if (dateAuj) dateAuj.value = `${yyyy}-${mm}-${dd}`;
        updateKmProjete();
        drawGraph();
      };
    }
    function updateKmProjete() {
      const anneesProj = document.getElementById("annees-projetees");
      const kmPar = document.getElementById("km-par-an");
      const kmProjete = document.getElementById("km-projet√©");
      const nbAn = parseInt(anneesProj.value) || 0;
      const kmYear = parseInt(kmPar.value) || 0;
      kmProjete.value = nbAn * kmYear;
    }
    function drawGraph() {
      const canvas = document.getElementById("canvas-graph");
      if (!canvas) return;
      const ctx = canvas.getContext("2d");
      if (!ctx) return;

      const {
        paddingLeft,
        graphWidth,
        graphHeight,
        yearsMin,
        yearsMax,
        kmMin,
        kmMax,
        stepYears,
        stepKm
      } = configG;

      // Vider le canvas
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Fond blanc pour la zone de trac√©
      ctx.fillStyle = "#fff";
      ctx.fillRect(paddingLeft - 15, 15, graphWidth + 30, graphHeight + 30);

      // Tracer les axes principaux
      ctx.save();
      ctx.strokeStyle = "#004472";
      ctx.lineWidth = 3.2;
      ctx.beginPath();
      ctx.moveTo(paddingLeft, 15);
      ctx.lineTo(paddingLeft, graphHeight + 15);
      ctx.stroke();
      ctx.restore();

      ctx.save();
      ctx.strokeStyle = "#444";
      ctx.lineWidth = 2.0;
      ctx.beginPath();
      ctx.moveTo(paddingLeft, graphHeight + 15);
      ctx.lineTo(paddingLeft + graphWidth, graphHeight + 15);
      ctx.stroke();
      ctx.restore();

      // Graduations sur l‚Äôaxe des ann√©es
      for (let i = yearsMin; i <= yearsMax; i += stepYears) {
        const x = paddingLeft + (graphWidth * (i - yearsMin)) / (yearsMax - yearsMin);
        ctx.beginPath();
        ctx.moveTo(x, graphHeight + 15);
        ctx.lineTo(x, graphHeight + 35);
        ctx.strokeStyle = "#888";
        ctx.lineWidth = 1.4;
        ctx.stroke();
        ctx.fillStyle = "#444";
        ctx.font = "20px Segoe UI";
        ctx.textAlign = "center";
        ctx.fillText(i + "a", x, graphHeight + 52);
      }

      // Graduations sur l‚Äôaxe des kilom√®tres
      for (let k = kmMin; k <= kmMax; k += stepKm) {
        const y = graphHeight + 15 - (graphHeight * (k - kmMin)) / (kmMax - kmMin);
        ctx.beginPath();
        ctx.moveTo(paddingLeft - 20, y);
        ctx.lineTo(paddingLeft, y);
        ctx.strokeStyle = "#888";
        ctx.lineWidth = 1.4;
        ctx.stroke();
        ctx.fillStyle = "#444";
        ctx.font = "19px Segoe UI";
        ctx.textAlign = "right";
        ctx.fillText(k.toLocaleString("fr-CA"), paddingLeft - 22, y + 6);
      }

      // Zone ‚ÄúGarantie de base‚Äù (3 ans / 60 000 km)
      const baseX1 = paddingLeft;
      const baseY1 = graphHeight + 15;
      const baseX2 = paddingLeft + (graphWidth * (3 - yearsMin)) / (yearsMax - yearsMin);
      const baseY2 = graphHeight + 15 - (graphHeight * (60000 - kmMin)) / (kmMax - kmMin);
      ctx.fillStyle = "#A3D8F4";
      ctx.strokeStyle = "#5A99B6";
      ctx.lineWidth = 4.6;
      ctx.beginPath();
      ctx.rect(baseX1, baseY2, baseX2 - baseX1, baseY1 - baseY2);
      ctx.fill();
      ctx.stroke();

      // Zone ‚ÄúGarantie d√©j√† consomm√©e‚Äù (hachures)
      const dateMise = document.getElementById("date-mise-en-service");
      const dateAuj = document.getElementById("date-aujourd‚Äôhui");
      let anneesCons = getYearsSince(dateMise.value, dateAuj.value);
      if (anneesCons < 0) anneesCons = 0;
      if (anneesCons > yearsMax) anneesCons = yearsMax;
      let kmCons = parseInt(document.getElementById("km-aujourd‚Äôhui").value) || 0;
      if (kmCons < kmMin) kmCons = kmMin;
      if (kmCons > kmMax) kmCons = kmMax;
      const hX2 =
        paddingLeft + (graphWidth * (anneesCons - yearsMin)) / (yearsMax - yearsMin);
      const hY2 =
        graphHeight + 15 - (graphHeight * (kmCons - kmMin)) / (kmMax - kmMin);
      if (hX2 > baseX1 && hY2 < baseY1) {
        ctx.save();
        ctx.beginPath();
        ctx.rect(baseX1, hY2, hX2 - baseX1, baseY1 - hY2);
        ctx.clip();
        ctx.strokeStyle = "#E06767";
        ctx.lineWidth = 10;
        for (let i = -graphHeight; i < graphWidth + graphHeight; i += 28) {
          ctx.beginPath();
          ctx.moveTo(baseX1 + i, graphHeight + 15);
          ctx.lineTo(baseX1 + i + 52, 15);
          ctx.stroke();
        }
        ctx.restore();
      }

      // Zone ‚ÄúProjection future‚Äù
      const nbAns = parseInt(document.getElementById("annees-projetees").value) || 0;
      const kmParAn = parseInt(document.getElementById("km-par-an").value) || 0;
      const kmTotal = nbAns * kmParAn;
      const kmProjete = document.getElementById("km-projet√©");
      kmProjete.value = kmTotal;

      let debutAn = anneesCons;
      let debutKm = kmCons;
      let finAn = Math.min(debutAn + nbAns, yearsMax);
      let finKm = Math.min(debutKm + kmTotal, kmMax);
      if (finAn < debutAn) finAn = debutAn;
      if (finKm < debutKm) finKm = debutKm;

      const garantieAn = 3;
      const garantieKm = 60000;
      const gX =
        paddingLeft + (graphWidth * (garantieAn - yearsMin)) / (yearsMax - yearsMin);
      const gY =
        graphHeight + 15 - (graphHeight * (garantieKm - kmMin)) / (kmMax - kmMin);
      const pX1 =
        paddingLeft + (graphWidth * (debutAn - yearsMin)) / (yearsMax - yearsMin);
      const pY1 =
        graphHeight + 15 - (graphHeight * (debutKm - kmMin)) / (kmMax - kmMin);
      const pX2 =
        paddingLeft + (graphWidth * (finAn - yearsMin)) / (yearsMax - yearsMin);
      const pY2 =
        graphHeight + 15 - (graphHeight * (finKm - kmMin)) / (kmMax - kmMin);

      // Ligne pointill√©e vers d√©but projection
      ctx.save();
      ctx.setLineDash([12, 8]);
      ctx.strokeStyle = "#c8102e99";
      ctx.lineWidth = 2.8;
      ctx.beginPath();
      ctx.moveTo(paddingLeft, graphHeight + 15);
      ctx.lineTo(pX1, pY1);
      ctx.stroke();
      ctx.setLineDash([]);
      ctx.restore();

      // Sous garantie (hachurage vert) ‚Äì jusqu‚Äô√† la limite de la garantie
      const sgFinAn = Math.min(garantieAn, finAn);
      const sgFinKm =
        Math.min(
          garantieKm,
          debutKm + Math.min(nbAns, garantieAn - debutAn) * kmParAn
        );
      const sX2 = paddingLeft + (graphWidth * (sgFinAn - yearsMin)) / (yearsMax - yearsMin);
      const sY2 =
        graphHeight + 15 - 
        (graphHeight * (sgFinKm - kmMin)) / (kmMax - kmMin);
      if (sgFinAn > debutAn && sgFinKm > debutKm) {
        const eX = Math.min(sX2, baseX2);
        const eY = Math.min(sY2, baseY2);
        drawHachureRect(pX1, pY1, eX, eY, "#00B245", 12, 4, 45);
      }

      // Hors garantie (zone verte claire)
      if (finAn > garantieAn || finKm > garantieKm) {
        const startX = Math.max(sX2, gX);
        const startY = Math.max(sY2, gY);
        if (pX2 > startX && startY > pY2) {
          ctx.save();
          ctx.fillStyle = "#A8E6B6";
          ctx.strokeStyle = "#54BB7C";
          ctx.lineWidth = 4.6;
          ctx.beginPath();
          ctx.rect(startX, pY2, pX2 - startX, startY - pY2);
          ctx.fill();
          ctx.stroke();
          ctx.restore();
        }
      }

      // Point actuel (cercle rouge)
      ctx.save();
      ctx.beginPath();
      ctx.arc(pX1, pY1, 7, 0, 2 * Math.PI, false);
      ctx.fillStyle = "#C8102E";
      ctx.strokeStyle = "#fff";
      ctx.lineWidth = 2.4;
      ctx.shadowColor = "#C8102E88";
      ctx.shadowBlur = 10;
      ctx.fill();
      ctx.stroke();
      ctx.restore();

      let htmlGlow = document.getElementById("point-glow");
      if (!htmlGlow) {
        htmlGlow = document.createElement("div");
        htmlGlow.id = "point-glow";
        htmlGlow.className = "point-glow";
        htmlGlow.style.position = "absolute";
        htmlGlow.style.pointerEvents = "none";
        htmlGlow.style.width = "18px";
        htmlGlow.style.height = "18px";
        htmlGlow.style.borderRadius = "50%";
        htmlGlow.style.background = "#C8102E";
        htmlGlow.style.border = "3px solid #fff";
        htmlGlow.style.boxShadow = "0 0 12px 3px rgba(215,0,25,0.6)";
        document.querySelector(".graph-area").appendChild(htmlGlow);
      }
      htmlGlow.style.left = `${pX1 - 9}px`;
      htmlGlow.style.top = `${pY1 - 9}px`;
    }
    function getYearsSince(dateStart, dateEnd) {
      const d1 = new Date(dateStart);
      const d2 = new Date(dateEnd);
      const diff = d2 - d1;
      return diff > 0 ? diff / (365.25 * 24 * 60 * 60 * 1000) : 0;
    }
    function drawHachureRect(x1, y1, x2, y2, color = "#00b245", spacing = 15, width = 4, angle = 45) {
      const canvas = document.getElementById("canvas-graph");
      if (!canvas) return;
      const ctx = canvas.getContext("2d");
      if (!ctx) return;
      ctx.save();
      ctx.beginPath();
      ctx.rect(x1, y2, x2 - x1, y1 - y2);
      ctx.clip();
      ctx.strokeStyle = color;
      ctx.lineWidth = width;
      const diag = Math.sqrt((x2 - x1) ** 2 + (y1 - y2) ** 2);
      const a = Math.tan((angle * Math.PI) / 180);
      for (let i = -diag; i < diag + Math.max(x2 - x1, y1 - y2); i += spacing) {
        ctx.beginPath();
        ctx.moveTo(x1 + i, y1);
        ctx.lineTo(x1 + i + (y1 - y2) / a, y2);
        ctx.stroke();
      }
      ctx.restore();
    }
    document.getElementById("btn-export-garantie")?.addEventListener("click", () => {
      const canvas = document.getElementById("canvas-graph");
      const htmlGlow = document.getElementById("point-glow");
      if (htmlGlow) htmlGlow.style.display = "none";
      setTimeout(() => {
        const link = document.createElement("a");
        link.download = "graphique_garantie.png";
        link.href = canvas.toDataURL();
        link.click();
        if (htmlGlow) htmlGlow.style.display = "block";
      }, 50);
    });
  </script>
</body>
</html>
